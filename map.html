<!DOCTYPE html>
<html>
<head>
  <title>Step Challenge Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      text-align: center;
      opacity: 0; /* Initial opacity for fade-in effect */
      transition: opacity 3s ease-in; /* Fade-in effect */
    }
    #map {
      height: 100vh;
      width: 100vw;
      position: relative; /* Ensure map is the reference for overlay positioning */
    }
    .locked-marker {
      filter: grayscale(100%);
    }
    .overlay {
      position: fixed; /* Use fixed to ensure it stays visible */
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.8); /* White background with transparency */
      color: #003366; /* Dark blue text color */
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 16px;
      text-align: center;
      z-index: 1000; /* Ensure overlay is on top */
      pointer-events: none; /* Make overlay non-interactive */
    }
    .music-controls {
      position: fixed;
      bottom: 60px;
      right: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      background: rgba(0, 0, 0, 0.8);
      padding: 10px;
      border-radius: 50px;
      z-index: 1001; /* Ensure music controls are above other content */
      color: white;
    }
    .music-button {
      display: inline-block;
      padding: 10px;
      background: rgba(0, 0, 0, 0.9);
      color: white;
      text-decoration: none;
      border-radius: 50%;
      font-size: 1.2em;
      cursor: pointer;
      border: none;
    }
    .music-button:hover {
      background: rgba(0, 0, 0, 1);
    }
    .song-title {
      color: white;
      font-size: 1em;
    }
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }
    .fade-out {
      animation: fadeOut 3s forwards;
    }
    .playlist-button {
      position: fixed;
      bottom: 130px;
      right: 20px;
      padding: 10px 20px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      text-decoration: none;
      border-radius: 20px;
      z-index: 1001;
      font-size: 1.2em;
      cursor: pointer;
    }
    .playlist-button:hover {
      background: rgba(0, 0, 0, 1);
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <!-- Overlay for quote and step information -->
  <div class="overlay" id="overlay">
    <p id="quote">"Alone we can do so little; together we can do so much." – Helen Keller</p>
    <p id="steps-info"></p>
  </div>
  <!-- Audio element for background music -->
  <audio id="background-music" src="500 Miles.mp3" preload="auto" autoplay loop></audio>
  <!-- Music control buttons -->
  <div class="music-controls">
    <button class="music-button" onclick="playMusic()"><i class="fas fa-play"></i></button>
    <button class="music-button" onclick="pauseMusic()"><i class="fas fa-pause"></i></button>
    <span class="song-title">500 Miles</span>
  </div>
  <!-- Playlist button -->
  <a href="playlist.html" class="playlist-button">Go to Playlist</a>
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script>
    // Simulate step data (in a real scenario, you would fetch this from a server or file)
    const stepData = {
        currentSteps: 85000, // Example current steps
        targets: [
          { name: 'Sitges, Spain', stepsRequired: 0, url: 'page_sitges.html' },
          { name: 'Barcelona, Spain', stepsRequired: 71400, url: 'page_barcelona.html' }, // 23.8 miles
          { name: 'Mataró, Spain', stepsRequired: 133800, url: 'page_mataro.html' }, // 71,400 + 62,400 (total steps from start)
          { name: 'Blanes, Spain', stepsRequired: 185700, url: 'page_blanes.html' }, // 133,800 + 51,900
          { name: 'Cadaqués, Spain', stepsRequired: 321300, url: 'page_cadaques.html' }, // 185,700 + 135,600
          { name: 'Perpignan, France', stepsRequired: 406500, url: 'page_perpignan.html' }, // 321,300 + 85,200
          { name: 'Narbonne, France', stepsRequired: 525900, url: 'page_narbonne.html' }, // 406,500 + 119,400
          { name: 'Béziers, France', stepsRequired: 574200, url: 'page_beziers.html' }, // 525,900 + 48,300
          { name: 'Sète, France', stepsRequired: 617100, url: 'page_sete.html' }, // 574,200 + 42,900
          { name: 'Montpellier, France', stepsRequired: 672900, url: 'page_montpellier.html' }, // 617,100 + 55,800
          { name: 'Arles, France', stepsRequired: 814500, url: 'page_arles.html' }, // 672,900 + 141,600
          { name: 'Marseille, France', stepsRequired: 977700, url: 'page_marseille.html' } // 814,500 + 163,200
        ]
      };
      
      // Initialize the map and set its view to Sitges, Spain
      const map = L.map('map').setView([41.2351, 1.8089], 6);
      
      // Add a tile layer to add to our map, in this case, it's an OpenStreetMap tile layer
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Map data © <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);
      
      // Array of locations with latitude, longitude, name, and URL
      const locations = stepData.targets.map(target => ({
        lat: getLat(target.name),
        lng: getLng(target.name),
        name: target.name,
        url: target.url,
        stepsRequired: target.stepsRequired
      }));
      
      function getLat(name) {
        switch (name) {
          case 'Sitges, Spain': return 41.2351;
          case 'Barcelona, Spain': return 41.3809;
          case 'Mataró, Spain': return 41.4965;
          case 'Blanes, Spain': return 41.7224;
          case 'Cadaqués, Spain': return 42.3042;
          case 'Perpignan, France': return 42.7078;
          case 'Narbonne, France': return 43.0950;
          case 'Béziers, France': return 43.2126;
          case 'Sète, France': return 43.3444;
          case 'Montpellier, France': return 43.6108;
          case 'Arles, France': return 43.5668;
          case 'Marseille, France': return 43.2965;
          default: return 0;
        }
      }
      
      function getLng(name) {
        switch (name) {
          case 'Sitges, Spain': return 1.8089;
          case 'Barcelona, Spain': return 2.1228;
          case 'Mataró, Spain': return 2.4445;
          case 'Blanes, Spain': return 2.7923;
          case 'Cadaqués, Spain': return 3.2792;
          case 'Perpignan, France': return 2.8948;
          case 'Narbonne, France': return 2.9974;
          case 'Béziers, France': return 3.2187;
          case 'Sète, France': return 3.6976;
          case 'Montpellier, France': return 3.8772;
          case 'Arles, France': return 4.6277;
          case 'Marseille, France': return 5.3698;
          default: return 0;
        }
      }
      
      // Function to check if a location is unlocked based on current steps
      function isUnlocked(locationName) {
        const target = stepData.targets.find(target => target.name === locationName);
        return target && stepData.currentSteps >= target.stepsRequired;
      }
      
      // Update overlay with current steps and next target
      function updateOverlay() {
        const overlay = document.getElementById('steps-info');
        const nextTarget = stepData.targets.find(target => stepData.currentSteps < target.stepsRequired);
        if (nextTarget) {
          const stepsRemaining = nextTarget.stepsRequired - stepData.currentSteps;
          overlay.innerHTML = `Current Steps: ${stepData.currentSteps}<br>Next Target: ${nextTarget.name}<br>Steps to Next Target: ${stepsRemaining}`;
        } else {
          overlay.innerHTML = `Current Steps: ${stepData.currentSteps}<br>All targets reached!`;
        }
      }
      
      // Function to handle marker click
      function handleMarkerClick(url) {
        document.body.classList.add('fade-out');
        const music = document.getElementById('background-music');
        music.volume = 1.0;
        const fadeAudio = setInterval(() => {
          if (music.volume > 0.05) {
            music.volume -= 0.05;
          } else {
            clearInterval(fadeAudio);
            music.pause();
            window.location.href = url;
          }
        }, 200); // fade out over 4 seconds (200ms * 20 = 4000ms)
      }
      
      // Loop through locations and add markers to the map
      locations.forEach(loc => {
        const unlocked = isUnlocked(loc.name);
        const marker = L.marker([loc.lat, loc.lng], {
          className: unlocked ? '' : 'locked-marker'
        }).addTo(map);
      
        marker.bindTooltip(loc.name, {
          permanent: false,
          direction: 'top'
        });
      
        if (unlocked) {
          marker.on('click', function() {
            handleMarkerClick(loc.url);
          });
        } else {
          const stepsRequired = loc.stepsRequired;
          const stepsRemaining = stepsRequired - stepData.currentSteps;
          marker.bindPopup(`<b>${loc.name}</b><br>Location locked. You need ${stepsRemaining} more steps to unlock.`);
        }
      });
      
      // Function to update the map when steps are updated (in a real scenario, this would be called when step data is updated)
      function updateSteps(newStepCount) {
        stepData.currentSteps = newStepCount;
        map.eachLayer(layer => {
          if (layer instanceof L.Marker) {
            const popupContent = layer.getPopup().getContent();
            const locationNameMatch = popupContent.match(/<b>(.*?)<\/b>/);
            if (locationNameMatch) {
              const locationName = locationNameMatch[1];
              const unlocked = isUnlocked(locationName);
              if (unlocked) {
                layer.setPopupContent(`<b>${locationName}</b><br><a href="${locations.find(loc => loc.name === locationName).url}" target="_self">More info</a>`);
                layer.getElement().classList.remove('locked-marker');
                layer.off('click');
                layer.on('click', function() {
                  handleMarkerClick(locations.find(loc => loc.name === locationName).url);
                });
              } else {
                const stepsRequired = stepData.targets.find(target => target.name === locationName).stepsRequired;
                const stepsRemaining = stepsRequired - stepData.currentSteps;
                layer.setPopupContent(`<b>${locationName}</b><br>Location locked. You need ${stepsRemaining} more steps to unlock.`);
              }
            }
          }
        });
        updateOverlay(); // Update overlay when steps are updated
      }
      
      // Initial overlay update
      updateOverlay();
      
  </script>
  <script src="map.js"></script>
</body>
</html>
